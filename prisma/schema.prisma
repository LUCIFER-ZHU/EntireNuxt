// ============================================================
// Prisma Schema 定义文件
// 文档: https://pris.ly/d/prisma-schema
// ============================================================

generator client {
  provider   = "prisma-client-js"
  engineType = "library"
}

datasource db {
  provider = "postgresql"
}

// ============================================================
// 1. 用户模型 (User)
// 说明: 系统的核心用户表，支持多种角色和状态管理
// 关系:
//   - 1对多: User → Product (一个用户可以发布多个产品)
//   - 1对多: User → ContactForm (一个用户可以提交多个表单)
//   - 1对多: User → Customer (一个业务员可以跟进多个客户)
// ============================================================
model User {
  // --- 主键 ---
  id String @id @default(uuid()) @db.Uuid
    // UUID 主键，使用数据库原生 UUID 生成

  // --- 认证信息 ---
  email String @unique @db.VarChar(255)
    // 邮箱地址，用于登录，全局唯一

  password String @db.VarChar(255)
    // 密码哈希（使用 bcrypt 加密存储，绝不存明文）

  // --- 基本信息 ---
  name String @db.VarChar(100)
    // 用户显示名称

  avatar String? @db.VarChar(500)
    // 头像 URL（可选）

  // --- 权限与状态 ---
  role UserRole @default(USER)
    // 用户角色，默认普通用户

  status UserStatus @default(ACTIVE)
    // 账户状态，默认激活

  // --- 时间戳 ---
  createdAt DateTime @default(now()) @db.Timestamp(6)
    // 创建时间，自动设置

  updatedAt DateTime @updatedAt @db.Timestamp(6)
    // 更新时间，自动更新

  // --- 关系定义 ---
  products Product[]
    // 用户发布的产品列表

  contactForms ContactForm[]
    // 用户提交的表单列表

  customers Customer[]
    // 业务员跟进的客户列表（反向关系）

  // --- 索引优化 ---
  @@index([email])
    // 加速邮箱查找（登录时使用）

  @@index([role])
    // 加速按角色筛选

  @@index([status])
    // 加速按状态筛选

  @@map("users")
}

// ============================================================
// 2. 产品模型 (Product)
// 说明: 产品信息表，支持草稿、审核、发布等状态流转
// 关系:
//   - 多对1: Product → User (每个产品属于一个用户)
// ============================================================
model Product {
  // --- 主键 ---
  id String @id @default(uuid()) @db.Uuid

  // --- 关联用户 ---
  userId String @db.Uuid @map("user_id")
    // 外键：关联到 User 表

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
    // 关系：产品所属用户
    // onDelete: Cascade 表示删除用户时级联删除其产品

  // --- 产品信息 ---
  title String @db.VarChar(200)
    // 产品标题

  description String? @db.Text
    // 产品描述（支持富文本）

  price Decimal? @db.Decimal(10, 2)
    // 价格，最多10位数字，2位小数

  images String[] @db.VarChar(500)
    // 产品图片 URL 数组

  category String? @db.VarChar(100)
    // 产品分类

  tags String[] @db.VarChar(50)
    // 产品标签数组

  // --- 状态 ---
  status ProductStatus @default(DRAFT)
    // 产品状态

  // --- 时间戳 ---
  createdAt DateTime @default(now()) @db.Timestamp(6)
  updatedAt DateTime @updatedAt @db.Timestamp(6)

  @@index([userId])
  @@index([status, createdAt])
  @@index([category])

  @@map("products")
}

// ============================================================
// 3. 联系表单模型 (ContactForm)
// 说明: 存储用户的咨询、反馈等表单提交
// 关系:
//   - 多对1: ContactForm → User (可选，已登录用户提交)
// ============================================================
model ContactForm {
  // --- 主键 ---
  id String @id @default(uuid()) @db.Uuid

  // --- 关联用户（可选）---
  userId String? @db.Uuid @map("user_id")
    // 如果用户已登录，记录用户ID

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)
    // onDelete: SetNull 表示删除用户时保留表单，只是清空关联

  // --- 联系信息 ---
  name String @db.VarChar(100)
    // 提交者姓名

  email String @db.VarChar(255)
    // 联系邮箱

  phone String? @db.VarChar(20)
    // 联系电话（可选）

  // --- 表单内容 ---
  subject String @db.VarChar(255)
    // 主题/标题

  message String @db.Text
    // 详细内容

  productId String? @db.Uuid @map("product_id")
    // 关联的产品 ID（如果是产品询盘）

  // --- 状态 ---
  status FormStatus @default(PENDING)
    // 处理状态

  // --- 时间戳 ---
  createdAt DateTime @default(now()) @db.Timestamp(6) @map("created_at")
  updatedAt DateTime @updatedAt @db.Timestamp(6) @map("updated_at")

  @@index([userId])
  @@index([status, createdAt])
  @@index([email])

  @@map("contact_forms")
}

// ============================================================
// 4. 枚举类型定义
// 说明: 限制字段只能取特定值，保证数据一致性
// ============================================================

// --------------------------------------------------------
// 4.1 用户角色枚举
// 说明: 定义系统中的用户权限级别
// --------------------------------------------------------
enum UserRole {
  USER      // 普通用户：可以浏览、提交表单、管理自己的产品
  ADMIN     // 管理员：拥有所有权限
  MODERATOR // 版主/审核员：可以审核内容，但不能管理用户
}

// --------------------------------------------------------
// 4.2 用户状态枚举
// 说明: 用于软删除和账户封禁
// --------------------------------------------------------
enum UserStatus {
  ACTIVE    // 正常状态
  INACTIVE  // 未激活（如邮箱未验证）
  SUSPENDED // 已封禁/暂停
  DELETED   // 已删除（软删除标记）
}

// --------------------------------------------------------
// 4.3 产品状态枚举
// --------------------------------------------------------
enum ProductStatus {
  DRAFT     // 草稿：仅自己可见
  PENDING   // 待审核：已提交等待审核
  PUBLISHED // 已发布：公开可见
  ARCHIVED  // 已归档：不再展示但保留数据
}

// --------------------------------------------------------
// 4.4 表单状态枚举
// --------------------------------------------------------
enum FormStatus {
  PENDING    // 待处理
  PROCESSING // 处理中
  COMPLETED  // 已完成
  CANCELLED  // 已取消
}

// --------------------------------------------------------
// 4.5 客户等级枚举
// --------------------------------------------------------
enum CustomerLevel {
  VIP      // VIP 客户
  GOLD     // 金牌客户
  SILVER   // 银牌客户
  BRONZE   // 铜牌客户
  REGULAR  // 普通客户
}

// --------------------------------------------------------
// 4.6 客户状态枚举
// --------------------------------------------------------
enum CustomerStatus {
  ACTIVE    // 活跃
  INACTIVE  //  inactive
  POTENTIAL // 潜在客户
  LOST      // 流失客户
}

// ============================================================
// 5. 客户模型 (Customer)
// 说明: 客户信息表，用于 CRM 管理
// 关系:
//   - 多对1: Customer → User (一个客户可能由多个业务员跟进)
// ============================================================
model Customer {
  // --- 主键 ---
  id String @id @default(uuid()) @db.Uuid

  // --- 基本信息 ---
  name String @db.VarChar(100)
    // 客户姓名/公司名称

  email String? @db.VarChar(255)
    // 客户邮箱

  phone String? @db.VarChar(20)
    // 客户电话

  company String? @db.VarChar(200)
    // 公司名称

  address String? @db.Text
    // 详细地址

  // --- 业务信息 ---
  level CustomerLevel @default(REGULAR)
    // 客户等级

  status CustomerStatus @default(ACTIVE)
    // 客户状态

  source String? @db.VarChar(100)
    // 客户来源（如：网站、推荐、展会等）

  industry String? @db.VarChar(100)
    // 所属行业

  notes String? @db.Text
    // 备注信息

  // --- 关联业务员 ---
  assignedTo String? @db.Uuid @map("assigned_to")
    // 分配给哪个用户（业务员）

  assignedUser User? @relation(fields: [assignedTo], references: [id], onDelete: SetNull)
    // 关联到 User 模型

  // --- 时间戳 ---
  createdAt DateTime @default(now()) @db.Timestamp(6) @map("created_at")
  updatedAt DateTime @updatedAt @db.Timestamp(6) @map("updated_at")

  // --- 索引优化 ---
  @@index([name])
    // 加速按名称搜索

  @@index([email])
    // 加速按邮箱搜索

  @@index([level])
    // 加速按等级筛选

  @@index([status])
    // 加速按状态筛选

  @@index([assignedTo])
    // 加速查找某个业务员的客户

  @@index([createdAt])
    // 加速按创建时间排序

  @@map("customers")
}
