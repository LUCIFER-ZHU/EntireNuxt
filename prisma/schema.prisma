// ============================================================
// Prisma Schema 定义文件
// 文件路径: prisma/schema.prisma
// 作用: 定义数据库表结构、关系、索引和约束
// 文档: https://www.prisma.io/docs/orm/prisma-schema
//
// 注意：Prisma 7+ 的数据库连接 URL 配置在 prisma.config.ts 中
//
// 常用命令:
//   npx prisma migrate dev    - 创建并应用迁移（开发环境）
//   npx prisma db push        - 直接推送 schema 到数据库（原型阶段）
//   npx prisma studio         - 打开可视化数据库管理界面
//   npx prisma generate       - 生成 Prisma Client
// ============================================================

// --------------------------------------------------------
// 1. 生成器配置
// 作用: 告诉 Prisma 如何生成客户端代码
// --------------------------------------------------------
generator client {
  // provider: 指定生成器类型
  // "prisma-client-js" 是官方提供的 TypeScript/JavaScript 生成器
  provider = "prisma-client-js"

  // output: 自定义生成路径（可选，默认在 node_modules/.prisma/client）
  // output = "../node_modules/.prisma/client"

  // previewFeatures: 启用实验性功能（按需开启）
  // previewFeatures = ["fullTextSearch", "fullTextIndex"]
}

// --------------------------------------------------------
// 2. 数据源配置
// 注意：Prisma 7+ 中，数据库连接 URL 配置在 prisma.config.ts 中
// 这里只需要指定 provider
// --------------------------------------------------------
datasource db {
  // provider: 数据库类型
  // 支持: postgresql, mysql, sqlite, sqlserver, mongodb, cockroachdb
  provider = "postgresql"
}

// ============================================================
// 3. 数据模型定义
// ============================================================

// --------------------------------------------------------
// 3.1 用户模型 (User)
// 说明: 存储用户账户信息，是系统的核心实体
// 关系:
//   - 1对多: User → Session (一个用户可有多个登录会话)
//   - 1对多: User → Product (一个用户可发布多个产品)
//   - 1对多: User → ContactForm (一个用户可提交多个表单)
// --------------------------------------------------------
model User {
  // --- 主键 ---
  id String @id @default(uuid()) @db.Uuid
    // @id: 标记此字段为主键
    // @default(uuid()): 自动生成 UUID v4 作为默认值
    // @db.Uuid: 在 PostgreSQL 中使用 UUID 类型存储（更高效）

  // --- 认证信息 ---
  email String @unique @db.VarChar(255)
    // @unique: 唯一约束，用于登录识别
    // @db.VarChar(255): 限制最大长度，防止存储攻击

  password String @db.VarChar(255)
    // 存储 bcrypt 加密后的密码哈希
    // ⚠️ 警告: 永远不要存储明文密码！
    // 加密在服务端完成，见 server/utils/password.ts

  emailVerified DateTime? @db.Timestamp(6)
    // 邮箱验证时间，null 表示未验证
    // ? 表示可选字段（nullable）
    // @db.Timestamp(6): 微秒精度时间戳

  // --- 基础信息 ---
  name String? @db.VarChar(100)
    // 用户昵称/姓名

  avatar String? @db.VarChar(500)
    // 头像 URL 或文件路径
    // 如果使用 Supabase Storage，存储的是文件路径

  phone String? @db.VarChar(20)
    // 联系电话

  company String? @db.VarChar(200)
    // 公司名称

  // --- 角色与权限 ---
  role UserRole @default(USER)
    // 用户角色，使用下方定义的枚举
    // @default(USER): 默认值为普通用户

  status UserStatus @default(ACTIVE)
    // 账户状态，用于软删除/封禁

  // --- 时间戳 ---
  createdAt DateTime @default(now()) @db.Timestamp(6)
    // 记录创建时间，@default(now()) 自动填充当前时间

  updatedAt DateTime @updatedAt @db.Timestamp(6)
    // 记录最后更新时间，@updatedAt 自动更新

  // --- 关系定义 ---
  sessions Session[]
    // 关联 Session 模型
    // 表示"一个用户可以有多个登录会话"
    // Prisma 会自动在 Session 表创建 userId 外键

  products Product[]
    // 关联 Product 模型（用户发布的产品）

  contactForms ContactForm[]
    // 关联 ContactForm 模型（用户提交的询盘表单）

  // --- 索引优化 ---
  @@index([email])
    // 为 email 创建索引，加速登录查询
    // 虽然 email 已有 @unique（自动创建索引），显式声明更清晰

  @@index([createdAt])
    // 为 createdAt 创建索引，加速"按注册时间排序"查询

  @@index([role, status])
    // 复合索引，加速"查找所有活跃用户"等组合查询

  @@map("users")
    // 映射到数据库中的实际表名（小写复数形式）
    // 如果不指定，Prisma 默认使用模型名（User）
}

// --------------------------------------------------------
// 3.2 会话模型 (Session)
// 说明: 管理用户登录会话，支持多设备登录
// 安全特性:
//   - 每个会话有独立的 refresh token
//   - 可单独撤销某个会话（如登出某设备）
//   - 记录登录 IP 和设备信息用于安全审计
// --------------------------------------------------------
model Session {
  id String @id @default(uuid()) @db.Uuid

  // --- 外键关系 ---
  userId String @db.Uuid
    // 关联到 User.id 的外键

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
    // @relation: 定义与 User 模型的关系
    // fields: 本表的外键字段（userId）
    // references: 关联表的主键字段（User.id）
    // onDelete: Cascade 表示删除用户时级联删除其所有会话

  // --- Token 信息 ---
  refreshToken String @unique @db.VarChar(500)
    // Refresh Token 的哈希值（不是明文！）
    // 用于在 access_token 过期后获取新的 token

  expiresAt DateTime @db.Timestamp(6)
    // Refresh Token 过期时间
    // 超过此时间后，用户需要重新登录

  // --- 设备信息（用于安全审计）---
  ipAddress String? @db.VarChar(45)
    // 登录 IP 地址（支持 IPv6 所以用 45 字符）

  userAgent String? @db.VarChar(500)
    // 浏览器 User-Agent 字符串

  // --- 时间戳 ---
  createdAt DateTime @default(now()) @db.Timestamp(6)
  lastUsedAt DateTime @default(now()) @db.Timestamp(6)
    // 最后使用时间，用于识别长期未用的会话

  @@index([userId])
    // 加速"查找某用户的所有会话"查询

  @@index([refreshToken])
    // 加速 Token 验证查询（虽然已有 @unique，显式声明更清晰）

  @@index([expiresAt])
    // 加速"查找过期会话"查询（用于清理任务）

  @@map("sessions")
}

// --------------------------------------------------------
// 3.3 产品模型 (Product)
// 说明: 产品/商品信息表
// --------------------------------------------------------
model Product {
  id String @id @default(uuid()) @db.Uuid

  // --- 外键关系 ---
  userId String @db.Uuid

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  // --- 产品信息 ---
  name String @db.VarChar(255)
    // 产品名称

  slug String @unique @db.VarChar(255)
    // URL 友好的唯一标识（如 "cnc-machine-2024"）
    // 用于构建产品详情页链接

  description String? @db.Text
    // 产品描述，使用 Text 类型支持长文本

  price Decimal? @db.Decimal(12, 2)
    // 价格，使用 Decimal 避免浮点数精度问题
    // @db.Decimal(12, 2): 共 12 位数字，其中 2 位小数

  currency String? @default("USD") @db.VarChar(3)
    // 货币代码（ISO 4217），默认美元

  // --- 媒体 ---
  images String[] @default([])
    // 产品图片 URL 数组
    // PostgreSQL 支持数组类型

  // --- 状态 ---
  status ProductStatus @default(DRAFT)
    // 发布状态

  viewCount Int @default(0)
    // 浏览次数

  // --- 时间戳 ---
  createdAt DateTime @default(now()) @db.Timestamp(6)
  updatedAt DateTime @updatedAt @db.Timestamp(6)

  publishedAt DateTime? @db.Timestamp(6)
    // 实际发布时间（与 createdAt 不同，这是点击"发布"的时间）

  // --- SEO ---
  metaTitle String? @db.VarChar(255)
  metaDescription String? @db.VarChar(500)

  @@index([userId])
  @@index([slug])
  @@index([status, createdAt])
    // 复合索引，加速"查找已发布产品并按时间排序"

  @@map("products")
}

// --------------------------------------------------------
// 3.4 询盘表单模型 (ContactForm)
// 说明: 用户提交的联系/询盘表单
// --------------------------------------------------------
model ContactForm {
  id String @id @default(uuid()) @db.Uuid

  // --- 外键关系（可选）---
  userId String? @db.Uuid
    // ? 表示未登录用户也可以提交表单

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)
    // onDelete: SetNull 表示删除用户时，保留表单但清空 userId

  // --- 联系信息 ---
  name String @db.VarChar(100)
  email String @db.VarChar(255)
  phone String? @db.VarChar(20)
  company String? @db.VarChar(200)

  // --- 表单内容 ---
  subject String @db.VarChar(255)
    // 主题/标题

  message String @db.Text
    // 详细内容

  productId String? @db.Uuid
    // 关联的产品 ID（如果是产品询盘）

  // --- 状态 ---
  status FormStatus @default(PENDING)
    // 处理状态

  // --- 时间戳 ---
  createdAt DateTime @default(now()) @db.Timestamp(6)
  updatedAt DateTime @updatedAt @db.Timestamp(6)

  @@index([userId])
  @@index([status, createdAt])
  @@index([email])

  @@map("contact_forms")
}

// ============================================================
// 4. 枚举类型定义
// 说明: 限制字段只能取特定值，保证数据一致性
// ============================================================

// --------------------------------------------------------
// 4.1 用户角色枚举
// 说明: 定义系统中的用户权限级别
// --------------------------------------------------------
enum UserRole {
  USER      // 普通用户：可以浏览、提交表单、管理自己的产品
  ADMIN     // 管理员：拥有所有权限
  MODERATOR // 版主/审核员：可以审核内容，但不能管理用户
}

// --------------------------------------------------------
// 4.2 用户状态枚举
// 说明: 用于软删除和账户封禁
// --------------------------------------------------------
enum UserStatus {
  ACTIVE    // 正常状态
  INACTIVE  // 未激活（如邮箱未验证）
  SUSPENDED // 已封禁/暂停
  DELETED   // 已删除（软删除标记）
}

// --------------------------------------------------------
// 4.3 产品状态枚举
// --------------------------------------------------------
enum ProductStatus {
  DRAFT     // 草稿：仅自己可见
  PENDING   // 待审核：已提交等待审核
  PUBLISHED // 已发布：公开可见
  ARCHIVED  // 已归档：不再展示但保留数据
}

// --------------------------------------------------------
// 4.4 表单状态枚举
// --------------------------------------------------------
enum FormStatus {
  PENDING    // 待处理
  PROCESSING // 处理中
  COMPLETED  // 已完成
  CANCELLED  // 已取消
}
